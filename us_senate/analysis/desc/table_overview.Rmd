---
title: "US Senate Polls"
output: html_document
---

```{r setup, include=FALSE}
library(readr)
library(knitr)
library(formattable)
library(tidyverse)


# merge data
polls <- readRDS("~/Documents/Uni/PollingError/senate/data/senate_polls1998_2018_score.RDS")


# fix gender / race data
polls <- polls %>%
  mutate(clarifai_race_rep = replace(clarifai_race_rep, clarifai_race_rep == 'Alan Schlesinger', 'white'),
         clarifai_race_rep = replace(clarifai_race_rep, clarifai_race_rep == 'Dan Bongino', 'hispanic'),
         clarifai_race_rep = replace(clarifai_race_rep, clarifai_race_rep == 'Jim Huffman', 'white'),
         clarifai_race_rep = replace(clarifai_race_rep, clarifai_race_rep == 'Linda Smith', 'white'),
         clarifai_race_rep = replace(clarifai_race_rep, clarifai_race_rep == 'Lou Barletta', 'white'),
         clarifai_race_rep = replace(clarifai_race_rep, clarifai_race_rep == 'Philip Giordano', 'white'),
         clarifai_race_rep = replace(clarifai_race_rep, clarifai_race_rep == 'Rick Lazio', 'white'),
         clarifai_race_rep = replace(clarifai_race_rep, clarifai_race_rep == 'Robert Lorge', 'hispanic')) %>%
  as.data.frame()

polls <- polls %>%
  mutate(clarifai_race_dem = replace(clarifai_race_dem, clarifai_race_dem == 'Barbara Boxer', 'white'),
         clarifai_race_dem = replace(clarifai_race_dem, clarifai_race_dem == 'Bob Menendez', 'white'),
         clarifai_race_dem = replace(clarifai_race_dem, clarifai_race_dem == 'Catherine Cortez Masto', 'white'),
         clarifai_race_dem = replace(clarifai_race_dem, clarifai_race_dem == 'Harold Ford Jr.', 'black'),
         clarifai_race_dem = replace(clarifai_race_dem, clarifai_race_dem == 'Ken Salazar', 'white'),
         clarifai_race_dem = replace(clarifai_race_dem, clarifai_race_dem == 'Paul Hodes', 'white'),
         clarifai_race_dem = replace(clarifai_race_dem, clarifai_race_dem == 'Rick Noriega', 'white'),
         clarifai_race_dem = replace(clarifai_race_dem, clarifai_race_dem == 'Sam Granato', 'white')) %>%
  as.data.frame()

polls <- polls %>%
  mutate(clarifai_gender_dem = replace(clarifai_gender_dem, clarifai_gender_dem == 'Misty K. Snow', 'feminine'),
         clarifai_gender_rep = replace(clarifai_gender_rep, clarifai_gender_rep == 'Slade Gorton', 'masculine')) %>%
  as.data.frame()

# compute gender, race and incumbency dummy
polls <- polls %>%
  mutate(gender_rep_dummy = if_else(clarifai_gender_rep == 'feminine', 1, 0),
         gender_dem_dummy = if_else(clarifai_gender_dem == 'feminine', 1, 0),
         race_rep_dummy = if_else(clarifai_race_rep != 'white', 1, 0),
         race_dem_dummy = if_else(clarifai_race_dem != 'white', 1, 0),
         inc_rep_dummy = if_else(rep_candidate == senator, 1, 0),
         inc_dem_dummy = if_else(dem_candidate == senator, 1, 0),
         state_year = paste0(election_year, '_', state)
  )

# subset complete cases
# polls <- polls %>% 
#   subset(!is.na(gender_rep_dummy) &
#            !is.na(gender_dem_dummy) &
#            !is.na(race_rep_dummy) &
#            !is.na(race_dem_dummy) &
#            !is.na(n))

variables_table <- polls %>%
  select(election_year, state, rep_result2, rep_poll2, 
         gender_rep_dummy, gender_dem_dummy, race_rep_dummy, race_dem_dummy,
         inc_rep_dummy, inc_dem_dummy, cf_score_rep, cf_score_dem)

# aggregate election-level data
election <- variables_table %>% 
  group_by(election_year, state, gender_rep_dummy, gender_dem_dummy, 
           race_rep_dummy, race_dem_dummy, inc_rep_dummy, inc_dem_dummy, 
           cf_score_rep, cf_score_dem) %>% 
  summarise(n_polls = n(),
            bias_poll = round(mean(rep_poll2 - rep_result2), 5),
            var_poll = round(var(rep_poll2, na.rm = T), 5)) %>% 
  relocate(election_year, state, bias_poll, var_poll) %>% 
  arrange(bias_poll)
  


```

Overview by Election:

```{r table, echo=FALSE}

color_tile2 <- function (...) {
  formatter("span", style = function(x) {
    style(display = "block",
          padding = "0 4px", 
          `border-radius` = "4px", 
          `background-color` = csscolor(matrix(as.integer(colorRamp(...)(normalize(as.numeric(x)))), 
                                               byrow=TRUE, dimnames=list(c("red","green","blue"), NULL), nrow=3)))
  })}

formattable(election, list(
  bias_poll = color_tile2(c("red", "white", "green")),
  var_poll = color_tile("white", "red"),
  gender_rep_dummy = color_tile("white", "cornflowerblue"),
  gender_dem_dummy = color_tile("white", "cornflowerblue"),
  race_rep_dummy = color_tile("white", "cornflowerblue"),
  race_dem_dummy = color_tile("white", "cornflowerblue"),
  inc_rep_dummy = color_tile("white", "cornflowerblue"),
  inc_dem_dummy = color_tile("white", "cornflowerblue"),
  cf_score_rep = color_tile("white", "red"),
  cf_score_dem = color_tile("cornflowerblue", "white")
  )
)
```
